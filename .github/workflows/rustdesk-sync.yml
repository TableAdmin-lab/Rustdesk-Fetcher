name: RustDesk Master Sync
on:
  schedule:
    - cron: '0 0 1,15 * *' # Bi-monthly at midnight
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Check "True" to test without uploading'
        required: true
        type: boolean
        default: false

jobs:
  sync-rustdesk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: pip install google-api-python-client google-auth requests

      - name: Run Sync Logic
        id: process
        env:
          GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS_DATA }}
          LATEST_FOLDER: ${{ secrets.LATEST_FOLDER_ID }}
          LEGACY_FOLDER: ${{ secrets.LEGACY_FOLDER_ID }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: |
          python - <<EOF
          import os, json, requests
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload

          is_dry_run = os.environ.get('DRY_RUN') == 'true'
          
          # 1. Fetch Latest Release
          res = requests.get("https://api.github.com/repos/rustdesk/rustdesk/releases/latest").json()
          tag = res['tag_name']
          assets = [a for a in res['assets'] if "universal-signed.apk" in a['name']]
          
          if not assets:
              print("No universal APK found."); exit(1)
              
          dl_url = assets[0]['browser_download_url']
          actual_filename = assets[0]['name']

          # 2. Download
          r = requests.get(dl_url, stream=True)
          with open("rustdesk_universal.apk", 'wb') as f:
              for chunk in r.iter_content(chunk_size=8192):
                  f.write(chunk)
          
          if is_dry_run:
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"new_update=true\ntag={tag}-DRYRUN\n")
              exit(0)

          # 3. Google Drive Auth
          creds = service_account.Credentials.from_service_account_info(json.loads(os.environ['GDRIVE_CREDENTIALS']))
          drive = build('drive', 'v3', credentials=creds)

          # 4. Check Shared Drive
          query = f"'{os.environ['LATEST_FOLDER']}' in parents and trashed = false"
          results = drive.files().list(q=query, fields="files(id, name)", supportsAllDrives=True, includeItemsFromAllDrives=True).execute()
          existing_files = results.get('files', [])

          # CASE: NO UPDATE
          if any(actual_filename == f['name'] for f in existing_files):
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("new_update=false\n")
              exit(0)

          # CASE: UPDATE FOUND - Move old to Legacy
          for f in existing_files:
              drive.files().update(fileId=f['id'], addParents=os.environ['LEGACY_FOLDER'], removeParents=os.environ['LATEST_FOLDER'], supportsAllDrives=True).execute()

          # 5. Upload New
          file_metadata = {'name': actual_filename, 'parents': [os.environ['LATEST_FOLDER']]}
          media = MediaFileUpload('rustdesk_universal.apk', mimetype='application/vnd.android.package-archive', resumable=True)
          drive.files().create(body=file_metadata, media_body=media, fields='id', supportsAllDrives=True).execute()
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"new_update=true\ntag={tag}\n")
          EOF

      # --- NOTIFICATIONS ---

      - name: Slack - No Update Found
        if: steps.process.outputs.new_update == 'false'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ðŸ” *RustDesk Check:* No new version detected. (Running on autopilot)"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Slack - Update Success
        if: steps.process.outputs.new_update == 'true'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ðŸš€ *New RustDesk APK Uploaded!*\n*Version:* `${{ steps.process.outputs.tag }}`\n*Status:* Archived old version, uploaded new Universal APK to Shared Drive.\n\nðŸ“‚ <https://drive.google.com/drive/u/0/folders/${{ secrets.LATEST_FOLDER_ID }}|Open Latest Folder>\n\nCC: <@UK9CP7SGN> <@U07FVM1LQU8> <@U087XPGRE9Z>  "
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
